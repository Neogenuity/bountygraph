name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  RUST_TOOLCHAIN: stable
  SOLANA_VERSION: 1.18.0

jobs:
  # Job 1: Check code formatting and linting
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rustfmt, clippy
      
      - name: Check Rust formatting
        run: cargo fmt -- --check
      
      - name: Run Clippy
        run: cargo clippy -- -D warnings
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies (monorepo)
        run: npm install
      
      - name: Lint TypeScript (API)
        run: cd api && npm run lint
      
      - name: Lint TypeScript (UI)
        run: cd ui && npm run lint

  # Job 2: Compile on-chain program
  build-contract:
    name: Build On-Chain Program
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Rust project
        run: cargo build --release
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: contract-build
          path: target/release/bountygraph.so

  # Job 3: Run Rust/Anchor tests
  test-contract:
    name: Test On-Chain Program
    runs-on: ubuntu-latest
    needs: build-contract
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
          export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
          solana --version
      
      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Anchor tests
        run: anchor test --skip-build

  # Job 4: Test backend API
  test-api:
    name: Test Backend API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies (API)
        run: cd api && npm install
      
      - name: Run TypeScript compiler
        run: cd api && npx tsc --noEmit
      
      - name: Run API tests
        run: cd api && npm test

  # Job 5: Build frontend
  build-ui:
    name: Build Frontend UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies (UI)
        run: cd ui && npm install
      
      - name: Run TypeScript compiler
        run: cd ui && npx tsc --noEmit
      
      - name: Build Next.js
        run: cd ui && npm run build
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: ui-build
          path: ui/.next

  # Job 6: Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Audit Node dependencies
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Audit Rust dependencies
        run: cargo audit

  # Job 7: Update project status
  update-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    needs: [lint, build-contract, test-contract, test-api, build-ui, security]
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      - name: Determine overall status
        id: status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.build-contract.result }}" == "success" && "${{ needs.test-contract.result }}" == "success" && "${{ needs.test-api.result }}" == "success" && "${{ needs.build-ui.result }}" == "success" ]]; then
            echo "overall=success" >> $GITHUB_OUTPUT
          else
            echo "overall=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Post status to forum
        if: always()
        run: |
          # This would post a comment to the forum with CI status
          # Implementation depends on forum API availability
          echo "CI Status: ${{ steps.status.outputs.overall }}"

  # Job 8: Deployment (only on main branch)
  deploy-devnet:
    name: Deploy to Devnet (main only)
    runs-on: ubuntu-latest
    needs: [build-contract, test-contract]
    if: github.ref == 'refs/heads/main' && always()
    steps:
      - uses: actions/checkout@v3
      
      - name: Download contract build
        uses: actions/download-artifact@v3
        with:
          name: contract-build
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Setup Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
      
      - name: Deploy to Devnet
        env:
          SOLANA_KEYPAIR: ${{ secrets.SOLANA_DEVNET_KEYPAIR }}
        run: |
          export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
          echo "$SOLANA_KEYPAIR" > ~/.config/solana/id.json
          anchor deploy --provider.cluster devnet
        continue-on-error: true

  # Final: Summary
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, build-contract, test-contract, test-api, build-ui, security]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "=== CI/CD Pipeline Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build Contract: ${{ needs.build-contract.result }}"
          echo "Test Contract: ${{ needs.test-contract.result }}"
          echo "Test API: ${{ needs.test-api.result }}"
          echo "Build UI: ${{ needs.build-ui.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "================================"
